"use strict";module.exports=(e,{services:a,exceptions:s,logger:t,getSchema:r})=>{const{ItemsService:l,MetaService:i}=a;e.get("/",(async(e,a,s)=>{try{let{user_id:s,category:t,gallery:u,favorites:c,player:n,players:o,clubs:p,leagues:d,mode:y,limit:_,page:g}=e.query;const m=new l("news",{schema:await r()}),w=new l("users",{schema:await r()}),f=new i({schema:await r("news"),accountability:{admin:!0}});let h=null;s&&(h=await w.readOne(s,{fields:["cards","favorites"]}));let v=h&&h.cards?JSON.parse(h.cards).map((e=>e.player_slug)):[],b=h&&h.favorites?JSON.parse(h.favorites).map((e=>e.player_slug)):[],S={filter:{...t&&{category:t},...o&&{players:{players_id:{slug:{_in:o.split(",")}}}},...s&&c&&{players:{players_id:{slug:{_in:(o||"").split(",").concat(b)}}}},...s&&u&&{players:{players_id:{slug:{_in:(o||"").split(",").concat(v)}}}},...p&&{clubs:{clubs_id:{slug:{_in:p}}}},...d&&{leagues:{leagues_id:{slug:{_in:d}}}}},fields:["id","title","date_created","category","url","type","author.id","author.nickname","author.pictureUrl","author.squad","author.slug","players.players_id.id","players.players_id.slug","players.players_id.name","players.players_id.pictureUrl","clubs.clubs_id.*","leagues.leagues_id.*","source.*"],meta:["total_count","filter_count"],sort:["-date_created"],limit:parseInt(_)||20,offset:((parseInt(g)||1)-1)*(parseInt(_)||20)};return a.json({data:await m.readByQuery(S),meta:await f.getMetaForQuery("news",S)})}catch(e){return a.json({data:[],meta:{total_count:0,filter_count:0}})}}))};
