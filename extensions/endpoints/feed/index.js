"use strict";module.exports=(e,{services:t,exceptions:a,logger:r,getSchema:s})=>{const{ItemsService:n,MetaService:i,UtilsService:l}=t;e.get("/",(async(e,t,a)=>{try{let{user_id:a,category:r,gallery:l,favorites:o,player:c,players:u,clubs:d,leagues:p,mode:m,limit:w,page:_}=e.query;const y=new n("news",{schema:await s()}),g=new n("users",{schema:await s()}),h=new n("karma",{schema:await s()}),f=new i({schema:await s("news"),accountability:{admin:!0}});let k=null;a&&(k=await g.readOne(a,{fields:["cards","favorites"]}));let O=k&&k.cards?JSON.parse(k.cards).map((e=>e.player_slug)):[],j=k&&k.favorites?JSON.parse(k.favorites).map((e=>e.player_slug)):[],v={filter:{...r&&{category:r},...u&&{players:{players_id:{slug:{_in:u.split(",")}}}},...a&&o&&{players:{players_id:{slug:{_in:(u||"").split(",").concat(j)}}}},...a&&l&&{players:{players_id:{slug:{_in:(u||"").split(",").concat(O)}}}},...d&&{clubs:{clubs_id:{slug:{_in:d}}}},...p&&{leagues:{leagues_id:{slug:{_in:p}}}}},fields:["id","title","date_created","category","url","type","author.id","author.nickname","author.pictureUrl","author.squad","author.slug","players.players_id.id","players.players_id.slug","players.players_id.name","players.players_id.pictureUrl","clubs.clubs_id.*","leagues.leagues_id.*","source.*"],meta:["total_count","filter_count"],sort:["-date_created"],limit:parseInt(w)||20,offset:((parseInt(_)||1)-1)*(parseInt(w)||20)},I=await y.readByQuery(v),q=I.map((e=>e.id)),S=await h.readByQuery({filter:{sender:{_eq:a},target_news:{_in:q}}});return t.json({data:I.map((e=>({...e,vote:S.find((t=>t.target_news==e.id))?.points}))),meta:await f.getMetaForQuery("news",v)})}catch(e){return t.json(e.message)}})),e.get("/top-news",(async(e,t,a)=>{try{let{limit:a}=e.query;const i=new n("news",{schema:await s()});var r=new Date;r.setDate(r.getDate()-1);let l={filter:{date_created:{_gte:r.toISOString()},_and:[{score:{_nnull:!0}},{score:{_neq:0}}]},sort:["-score"],limit:a||10,meta:["total_count","filter_count"],fields:["id","score","title","category","players.players_id.name","players.players_id.pictureUrl"]};return t.json(await i.readByQuery(l))}catch(e){return t.json({data:[],meta:{total_count:0,filter_count:0}})}})),e.get("/top-users-month",(async(e,t,a)=>{try{let{limit:a}=e.query;const r=new n("users",{schema:await s()}),i=new n("karma",{schema:await s()});let l=new Date,o={filter:{target_user:{_nnull:!0},"year(date_created)":{_eq:l.getFullYear()},"month(date_created)":{_eq:l.getMonth()+1}},meta:["total_count","filter_count"],group:["target_user"],aggregate:{sum:["points"]},limit:-1},c=(await i.readByQuery(o)).sort(((e,t)=>parseInt(e.sum.points)>parseInt(t.sum.points)?-1:1)).slice(0,a||5);for(let e=0;e<(a||5);e++){let t=await r.readOne(c[e].target_user,{fields:["nickname","pictureUrl"]});c[e]={...t,points:c[e].sum.points}}return t.json(c)}catch(e){return t.json([])}})),e.get("/top-users-week",(async(e,t,a)=>{try{let{limit:a}=e.query;const i=new n("users",{schema:await s()}),l=new n("karma",{schema:await s()});var r=new Date;r.setDate(r.getDate()-7);let o={filter:{target_user:{_nnull:!0},date_created:{_gte:r.toISOString()}},meta:["total_count","filter_count"],group:["target_user"],aggregate:{sum:["points"]},limit:-1},c=(await l.readByQuery(o)).sort(((e,t)=>parseInt(e.sum.points)>parseInt(t.sum.points)?-1:1)).slice(0,a||5);for(let e=0;e<(a||5);e++){let t=await i.readOne(c[e].target_user,{fields:["nickname","pictureUrl"]});c[e]={...t,points:c[e].sum.points}}return t.json(c)}catch(e){return t.json([])}})),e.get("/vote-news",(async(e,t,a)=>{try{let{sender_id:a,news_id:i,target_user_id:l,vote:o}=e.query;const c={upvote:1,downvote:-1},u=new n("news",{schema:await s()}),d=new n("karma",{schema:await s()});let p=await d.readByQuery({filter:{sender:{_eq:a},target_news:{_eq:i}}}),m=null,w=c[o];0==p.length?m=await d.createOne({sender:a,target_news:i,target_user:l,points:c[o]}):p[0].points==c[o]?(m=await d.deleteOne(p[0].id),w=0):m=await d.updateOne(p[0].id,{points:c[o]}),await(async e=>{try{const t=new n("news",{schema:await s()});let a=(await t.readOne(e,{fields:["author","karma.points"]})).karma.reduce(((e,t)=>e+(parseInt(t.points)||0)),0);return await t.updateOne(e,{score:a})}catch(e){return r.error(e.message),null}})(i);let _=await u.readOne(i,{fields:["score"]});return(async e=>{try{const t=new n("users",{schema:await s()});let a=(await t.readOne(e,{fields:["karma.points"]})).karma.reduce(((e,t)=>e+(parseInt(t.points)||0)),0);await t.updateOne(e,{karma_score:a})}catch(e){return r.error(e.message),null}})(l),t.json({..._,vote:w})}catch(e){return t.json(e.message)}})),e.get("/compute-all-users-score",(async(e,t,a)=>{try{const e=new n("users",{schema:await s()});let a=await e.readByQuery({filter:{karma:{id:{_nnull:!0}}},limit:-1,meta:["total_count","filter_count"],fields:["id","karma.points"]}),r=0;for(let t=0;t<a.length;t++){console.log("users",t+1,"/",a.length);let s=a[t].karma.reduce(((e,t)=>e+(parseInt(t.points)||0)),0);await e.updateOne(a[t].id,{score:s}),r++}return t.json(r)}catch(e){return t.json(0)}})),e.get("/compute-all-news-score",(async(e,t,a)=>{try{const e=new n("news",{schema:await s()});let a=await e.readByQuery({limit:-1,fields:["id","karma.points"]}),r=0;for(let t=0;t<a.length;t++){console.log("news",t+1,"/",a.length);let s=a[t].karma.reduce(((e,t)=>e+(parseInt(t.points)||0)),0);await e.updateOne(a[t].id,{score:s}),r++}return t.json(r)}catch(e){return t.json({data:[],meta:{total_count:0,filter_count:0}})}})),e.get("/compute-news-score",(async(e,t,a)=>{try{let{news_id:a}=e.query;const r=new n("news",{schema:await s()});let i=(await r.readOne(a,{fields:["karma.*"]})).karma.reduce(((e,t)=>e+(parseInt(t.points)||0)),0),l=await r.updateOne(a,{score:i});return t.json(l)}catch(e){return t.json({data:[],meta:{total_count:0,filter_count:0}})}}))};
