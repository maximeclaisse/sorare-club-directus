"use strict";module.exports=(e,{services:t,exceptions:a,logger:s,getSchema:r})=>{const{ItemsService:n,MetaService:l}=t;e.get("/",(async(e,t,a)=>{try{let{user_id:a,status:i,u23:u,gallery:_,favorites:d,players:c,clubs:p,leagues:o,squad:g,limit:m,page:y}=e.query;const f=new n("players",{schema:await r()}),h=new n("users",{schema:await r()}),w=new l({schema:await r("players"),accountability:{admin:!0}});let b=null;a&&(b=await h.readOne(a,{fields:["cards","favorites"]}));let v=b&&b.cards?JSON.parse(b.cards).map((e=>e.player_slug)):[],S=b&&b.favorites?JSON.parse(b.favorites).map((e=>e.player_slug)):[];var s=new Date;s.setDate(s.getDate()-7);let q={filter:{...i?{dnp_status:{_in:i}}:{_or:[{dnp_status:{_neq:"ok"}},{_and:[{dnp_status:{_eq:"back"},dnp_date_updated:{_gte:s.toISOString()}}]}]},...a&&d&&{slug:{_in:S}},...a&&_&&{slug:{_in:v}},...c&&{slug:{_in:c.split(",")}},...p&&{club:{slug:{_in:p.split(",")}}},...o&&{league:{slug:{_in:o.split(",")}}},...g&&{dnp_author:{nickname:{_eq:g}}},...u&&{_and:[{birth_date_i:{_nnull:!0}},{birth_date_i:{_gte:867747422}}]}},fields:["*","dnp_author.nickname","dnp_author.pictureUrl","dnp_author.slug","club.*","league.*"],meta:["total_count","filter_count"],sort:["league","club","name","-dnp_date_updated"],limit:parseInt(m)||20,offset:((parseInt(y)||1)-1)*(parseInt(m)||20)};return t.json({data:await f.readByQuery(q),meta:await w.getMetaForQuery("players",q)})}catch(e){return t.json({data:[],meta:{total_count:0,filter_count:0}})}}))};
