"use strict";module.exports=(e,{services:a,exceptions:t,logger:s,getSchema:r})=>{const{ItemsService:l,MetaService:i}=a,{ServiceUnavailableException:n}=t;e.get("/",(async(e,a,t)=>{try{let{user_id:t,status:n,u23:u,gallery:_,favorites:c,players:d,clubs:p,leagues:g,squad:o}=e.query;const y=new l("players",{schema:await r()}),m=new l("users",{schema:await r()}),w=new i({schema:await r("players"),accountability:{admin:!0}});let v=null;t&&(v=await m.readOne(t,{fields:["cards","favorites"]}));let b=v&&v.cards?JSON.parse(v.cards).map((e=>e.player_slug)):[],f=v&&v.favorites?JSON.parse(v.favorites).map((e=>e.player_slug)):[];var s=new Date;s.setDate(s.getDate()-7);let h={filter:{...n?{dnp_status:{_in:n}}:{_or:[{dnp_status:{_neq:"ok"}},{_and:[{dnp_status:{_eq:"back"},dnp_date_updated:{_gte:s.toISOString()}}]}]},...t&&c&&{slug:{_in:f}},...t&&_&&{slug:{_in:b}},...d&&{slug:{_in:d.split(",")}},...p&&{club:{slug:{_in:p.split(",")}}},...g&&{league:{slug:{_in:g.split(",")}}},...o&&{dnp_author:{nickname:{_eq:o}}},...u&&{_and:[{birth_date_i:{_nnull:!0}},{birth_date_i:{_gte:867747422}}]}},fields:["*","club.*","league.*"],meta:["total_count","filter_count"]};return a.json({data:await y.readByQuery(h),meta:await w.getMetaForQuery("players",h)})}catch(e){return t(new n(e.message))}}))};
